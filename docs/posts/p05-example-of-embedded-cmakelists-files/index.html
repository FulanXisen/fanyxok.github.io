<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Example of Embedded CMakeLists Files | 福岚溪森</title>
<meta name="keywords" content="CMake">
<meta name="description" content="Desc Text.">
<meta name="author" content="Me">
<link rel="canonical" href="https://canonical.url/to/page">
<link crossorigin="anonymous" href="/uildDrafts/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css" integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu&#43;hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/uildDrafts/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="uildDrafts/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="uildDrafts/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="uildDrafts/favicon-32x32.png">
<link rel="apple-touch-icon" href="uildDrafts/apple-touch-icon.png">
<link rel="mask-icon" href="uildDrafts/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><head>
    
</head><meta property="og:title" content="Example of Embedded CMakeLists Files" />
<meta property="og:description" content="Desc Text." />
<meta property="og:type" content="article" />
<meta property="og:url" content="uildDrafts/posts/p05-example-of-embedded-cmakelists-files/" />
<meta property="og:image" content="uildDrafts/%3Cimage%20path/url%3E" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-03T23:38:47&#43;08:00" />
<meta property="article:modified_time" content="2023-05-03T23:38:47&#43;08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="uildDrafts/%3Cimage%20path/url%3E" />
<meta name="twitter:title" content="Example of Embedded CMakeLists Files"/>
<meta name="twitter:description" content="Desc Text."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "uildDrafts/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Example of Embedded CMakeLists Files",
      "item": "uildDrafts/posts/p05-example-of-embedded-cmakelists-files/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Example of Embedded CMakeLists Files",
  "name": "Example of Embedded CMakeLists Files",
  "description": "Desc Text.",
  "keywords": [
    "CMake"
  ],
  "articleBody": "The most thoroughly commented embedded CMakeLists file January 05, 2023 - CMake Build System Embedded STM32\nMany embedded software engineers have had to deal with build systems that are either non cross-platform or a part of the IDE they are using, don’t offer easy composability or per-library configuration, provide no testing support or ways to generate or package files without using a third party scripting language.\nCMake is a build system that offers solutions to many of those problems and is already well adopted in the world of traditional software development. Inspired by The most thoroughly commented linker script blogpost and having used CMake in two different professional environments, I have decided to write an overview of a minimal CMakeLists file for an embedded project.\nHere is the CMakeLists file we are going to be taking a look at. It is a part of a CMake STM32 project i created as a demonstration and uses an STM32F103 MCU.\nThe minimum version cmake_minimum_required(VERSION 3.21) 这个调用语句必须位于每个CMakeLists文件的顶部，它设置了我们的项目构建所需要的最低CMake版本，并决定了可以使用的CMake功能。 通常建议将其设置的尽可能低，除非需要新版本CMake的功能。 另一个好的方法是检查repology获取大多数Linux发行版中所使用的CMake版本。\nProject declaration project(most_commented_embedded_cmakelists VERSION 1.0.0 DESCRIPTION \"This is a demo project\" ) The project() call sets up the project name and optionally version, description, homepage and more and stores them in variables that can be used later. For instance, the project name is stored in PROJECT_NAME, description in PROJECT_DESCRIPTION and so on.\nLanguage settings enable_language(C ASM) This sets the languages the project is going to be using, if C++ support is desired add CXX to the list.\nset(CMAKE_C_STANDARD 11) set(CMAKE_C_STANDARD_REQUIRED ON) 这个设置会在全局范围内指定使用的语言标准和是否将其作为必须条件。尽管这不是必须的，但由于 C 和 C++ 不向后兼容的特性，推荐使用。\nC11通常是项目的首选，因为它提供了有用的附加功能，如原子操作(atomics)，但它取消了可选功能，如可变长度数组(VLAs)，因此在处理旧项目时，C99或更低版本可能更适合。\nset(CMAKE_C_EXTENSIONS OFF) 这个命令用于全局控制是否包含C语言的GNU Extensions， 设置为OFF时更倾向于使用更标准和可移植的C，然而GNU Extensions提供的功能在基本标准之上提供了有用的东西。\nCompiler options set(MCU_OPTIONS -mcpu=cortex-m3 -mthumb ) 这里设置了一个自定义的microcontroller specific compiler flags变量。 首先，设置了CPU变体，然后告诉编译器发出thumb指令(thumb instructions)。\nset(EXTRA_OPTIONS -fdata-sections -ffunction-sections ) 这里设置了一个包含额外功能编译器标志的变量。此处添加的标志确保所有对象都放在单独的linker section中。稍后我们将看到这为什么很重要。\nset(OPTIMIZATION_OPTIONS $\u003c$",
  "wordCount" : "1127",
  "inLanguage": "en",
  "image":"uildDrafts/%3Cimage%20path/url%3E","datePublished": "2023-05-03T23:38:47+08:00",
  "dateModified": "2023-05-03T23:38:47+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "uildDrafts/posts/p05-example-of-embedded-cmakelists-files/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "福岚溪森",
    "logo": {
      "@type": "ImageObject",
      "url": "uildDrafts/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="uildDrafts" accesskey="h" title="福岚溪森 (Alt + H)">福岚溪森</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="uildDrafts">Home</a>&nbsp;»&nbsp;<a href="uildDrafts/posts/">Posts</a></div>
    <h1 class="post-title">
      Example of Embedded CMakeLists Files
    </h1>
    <div class="post-description">
      Desc Text.
    </div>
    <div class="post-meta"><span title='2023-05-03 23:38:47 +0800 CST'>May 3, 2023</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1127 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/%3cpath_to_repo%3e/content/posts/p05-example-of-embedded-cmakelists-files.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#the-minimum-version">The minimum version</a></li>
    <li><a href="#project-declaration">Project declaration</a></li>
    <li><a href="#language-settings">Language settings</a></li>
    <li><a href="#compiler-options">Compiler options</a></li>
    <li><a href="#linker-options">Linker options</a></li>
    <li><a href="#linking-the-standard-library">Linking the standard library</a></li>
    <li><a href="#adding-library-subprojects">Adding library subprojects</a></li>
    <li><a href="#the-executable">The executable</a></li>
    <li><a href="#post-build-commands">Post-build commands</a></li>
    <li><a href="#closing">Closing</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="the-most-thoroughly-commented-embedded-cmakelists-file">The most thoroughly commented embedded CMakeLists file<a hidden class="anchor" aria-hidden="true" href="#the-most-thoroughly-commented-embedded-cmakelists-file">#</a></h1>
<p>January 05, 2023 - <a href="https://dnedic.github.io/tags/cmake/">CMake</a> <a href="https://dnedic.github.io/tags/build-system/">Build System</a> <a href="https://dnedic.github.io/tags/embedded/">Embedded</a> <a href="https://dnedic.github.io/tags/stm32/">STM32</a></p>
<p>Many embedded software engineers have had to deal with build systems that are either non cross-platform or a part of the IDE they are using, don&rsquo;t offer easy composability or per-library configuration, provide no testing support or ways to generate or package files without using a third party scripting language.</p>
<p><a href="https://cmake.org/">CMake</a> is a build system that offers solutions to many of those problems and is already well adopted in the world of traditional software development. Inspired by <a href="https://blog.thea.codes/the-most-thoroughly-commented-linker-script/">The most thoroughly commented linker script</a> blogpost and having used CMake in two different professional environments, I have decided to write an overview of a minimal CMakeLists file for an embedded project.</p>
<p><a href="https://github.com/DNedic/most_commented_embedded_cmakelists/blob/main/CMakeLists.txt">Here</a> is the CMakeLists file we are going to be taking a look at. It is a part of a <a href="https://github.com/DNedic/most_commented_embedded_cmakelists">CMake STM32 project</a> i created as a demonstration and uses an STM32F103 MCU.</p>
<h2 id="the-minimum-version">The minimum version<a hidden class="anchor" aria-hidden="true" href="#the-minimum-version">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    cmake_minimum_required(<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.21</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这个调用语句必须位于每个CMakeLists文件的顶部，它设置了我们的项目构建所需要的最低CMake版本，并决定了可以使用的CMake功能。
通常建议将其设置的尽可能低，除非需要新版本CMake的功能。
另一个好的方法是检查<a href="https://repology.org/project/cmake/versions">repology</a>获取大多数Linux发行版中所使用的CMake版本。</p>
<h2 id="project-declaration">Project declaration<a hidden class="anchor" aria-hidden="true" href="#project-declaration">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    project(<span style="color:#e6db74">most_commented_embedded_cmakelists</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">1.0.0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">DESCRIPTION</span> <span style="color:#e6db74">&#34;This is a demo project&#34;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The <a href="https://cmake.org/cmake/help/latest/command/project.html">project()</a> call sets up the project name and optionally version, description, homepage and more and stores them in variables that can be used later. For instance, the project name is stored in <code>PROJECT_NAME</code>, description in <code>PROJECT_DESCRIPTION</code> and so on.</p>
<h2 id="language-settings">Language settings<a hidden class="anchor" aria-hidden="true" href="#language-settings">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    enable_language(<span style="color:#e6db74">C</span> <span style="color:#e6db74">ASM</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This sets the languages the project is going to be using, if C++ support is desired add <code>CXX</code> to the list.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">CMAKE_C_STANDARD</span> <span style="color:#e6db74">11</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_C_STANDARD_REQUIRED</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这个设置会在全局范围内指定使用的语言标准和是否将其作为必须条件。尽管这不是必须的，但由于 C 和 C++ 不向后兼容的特性，推荐使用。</p>
<p>C11通常是项目的首选，因为它提供了有用的附加功能，如原子操作(<a href="https://en.cppreference.com/w/c/atomic">atomics</a>)，但它取消了可选功能，如可变长度数组(<a href="https://en.wikipedia.org/wiki/Variable-length_array">VLAs</a>)，因此在处理旧项目时，C99或更低版本可能更适合。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">CMAKE_C_EXTENSIONS</span> <span style="color:#e6db74">OFF</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这个命令用于全局控制是否包含C语言的<a href="https://gcc.gnu.org/onlinedocs/gcc/C-Extensions.html">GNU Extensions</a>，
设置为OFF时更倾向于使用更标准和可移植的C，然而GNU Extensions提供的功能在基本标准之上提供了有用的东西。</p>
<h2 id="compiler-options">Compiler options<a hidden class="anchor" aria-hidden="true" href="#compiler-options">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">MCU_OPTIONS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-mcpu=cortex-m3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-mthumb</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这里设置了一个自定义的<a href="https://gcc.gnu.org/onlinedocs/gcc/ARM-Options.html">microcontroller specific compiler flags</a>变量。
首先，设置了CPU变体，然后告诉编译器发出thumb指令(<a href="https://developer.arm.com/documentation/ddi0337/e/Programmer-s-Model/Instruction-set">thumb instructions</a>)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">EXTRA_OPTIONS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-fdata-sections</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-ffunction-sections</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这里设置了一个包含额外功能编译器标志的变量。此处添加的标志确保所有对象都放在单独的linker section中。稍后我们将看到这为什么很重要。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">OPTIMIZATION_OPTIONS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">$&lt;</span>$&lt;CONFIG:Debug<span style="color:#f92672">&gt;</span><span style="color:#e6db74">:-Og&gt;</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>这里创建了编译器优化标志的自定义变量。当使用Debug(<a href="https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#build-configurations">configuration</a>)配置进行构建时, 这个奇怪的表达式有条件地将编译器优化级别设置为<code>-Og</code>。</p>
<p>由于大多数微控制器在闪存大小和CPU速度方面都相当有限，因此默认优化级别<code>-O0</code>不适合。<code>-Og</code>是一种最佳折衷方案，在大小、速度和调试可行性之间有最佳的优化。</p>
<p>其他配置使用它们的默认编译器优化级别，<code>Release</code>配置为<code>-O2</code>，<code>MinSizeRel</code>配置为<code>-Os</code>，因此不需要添加其他内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">DEPENDENCY_INFO_OPTIONS</span>
</span></span></code></pre></div><p>这里创建了一个包含Dependency Info Options的预处理器标志的自定义变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-MMD
</span></span></span></code></pre></div><p>这一行告诉预处理器为兼容Make的构建系统生成依赖文件，而不是完整的预处理器输出，同时删除系统头文件的提及。</p>
<blockquote>
<p><strong>Note:</strong> 如果我们自己需要预处理器的输出，可以向编译器传递<code>-E</code>参数.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-MP
</span></span></span></code></pre></div><p>此选项指示预处理器为除主文件以外的每个依赖项添加虚拟目标，以解决删除头文件而没有更新时构建系统出现的错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-MF</span> <span style="color:#960050;background-color:#1e0010">&#34;$(@:%.o=%.d)&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#960050;background-color:#1e0010">)
</span></span></span></code></pre></div><p>The last line specifies that we want the dependency files to be generated with the same name as the corresponding object file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">DEBUG_INFO_OPTIONS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-g3</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-gdwarf-2</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This creates a custom variable containing <a href="https://gcc.gnu.org/onlinedocs/gcc/Debugging-Options.html">compiler flags for generating debug information</a>. The first line tells the compiler to produce the debugging output and the level of detail while the second line configures the debug output format and version. We are using dwarf version 2 for best debugger compatibility.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_compile_options(
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>MCU_OPTIONS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>EXTRA_OPTIONS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>DEBUG_INFO_OPTIONS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>DEPENDENCY_INFO_OPTIONS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">${</span>OPTIMIZATION_OPTIONS<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Finally, all the created variables are used to set the global compiler options.</p>
<blockquote>
<p><strong>Note:</strong> It is possible to override these per-target by using <code>target_compile_options()</code>, for instance to apply a higher optimization level to third party libraries we are not going to be debugging.</p>
</blockquote>
<h2 id="linker-options">Linker options<a hidden class="anchor" aria-hidden="true" href="#linker-options">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_link_options(
</span></span></code></pre></div><p>Here we are adding global linker options.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">${MCU_OPTIONS}
</span></span></span></code></pre></div><p>First, it is required to pass the previously created microcontroller specific flags variable created earlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-specs=nano.specs
</span></span></span></code></pre></div><p>This tells the linker to include the nano variant of the <a href="https://sourceware.org/newlib/">newlib</a> standard library which is optimized for minimal binary size and RAM use. The regular newlib variant is used simply by not passing this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-T${CMAKE_SOURCE_DIR}/STM32F103C8Tx_FLASH.ld
</span></span></span></code></pre></div><p>Here the linkerscript of the chip is passed. The linkerscript tells the linker where to store the objects in memory. I recommend reading the already mentioned <a href="https://blog.thea.codes/the-most-thoroughly-commented-linker-script/">most thoroughly commented linker script</a> blogpost.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-Wl,-Map=${PROJECT_NAME}.map,--cref
</span></span></span></code></pre></div><p>This directive instructs the linker to generate a mapfile. Mapfiles contain information about the final layout of the firmware binary and are an invaluable resource for development. I recommend reading <a href="https://interrupt.memfault.com/blog/get-the-most-out-of-the-linker-map-file">this excellent Interrupt blogpost</a> for a quick introduction.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">-Wl,--gc-sections
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#960050;background-color:#1e0010">)
</span></span></span></code></pre></div><p>This is the linker flag for removing the unused sections from the final binary, it works in conjunction with the previously mentioned <code>-fdata-sections</code> and <code>-ffunction-sections</code> compiler flags to remove all unused objects from the final binary.</p>
<h2 id="linking-the-standard-library">Linking the standard library<a hidden class="anchor" aria-hidden="true" href="#linking-the-standard-library">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    link_libraries(<span style="color:#e6db74">&#34;-lc -lm -lnosys&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This call tells the linker to link the standard library components to all the libraries and executables added after the call.</p>
<p>The order of the standard library calls is important as the linker evaluates arguments one by one:</p>
<ul>
<li>-lc is the libc containing most standard library features</li>
<li>-lm is the libm containing math functionality</li>
<li>-lnosys provides stubs for the syscalls, essentially placeholders for what would be operating system calls</li>
</ul>
<h2 id="adding-library-subprojects">Adding library subprojects<a hidden class="anchor" aria-hidden="true" href="#adding-library-subprojects">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_subdirectory(<span style="color:#e6db74">Drivers</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>When a subdirectory is added, the CMakeLists file contained in that subdirectory is evaluated, this is usually chained for composability. In this case the <code>Drivers</code> CMakeLists file creates a static library called <code>Drivers</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    target_include_directories(<span style="color:#e6db74">Drivers</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Inc</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>We need to include the <code>Core/Inc</code> for the <code>Drivers</code> library, as it depends on the definitions inside the <code>Core</code> headers.</p>
<h2 id="the-executable">The executable<a hidden class="anchor" aria-hidden="true" href="#the-executable">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    set(<span style="color:#e6db74">EXECUTABLE</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">.elf</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This creates a variable containing the executable name by appending the <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a> extension to the project name.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_executable(<span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Src/main.c</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Src/stm32f1xx_hal_msp.c</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Src/stm32f1xx_it.c</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Src/system_stm32f1xx.c</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">startup_stm32f103xb.s</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Here we are creating the executable target and adding top-level sources to it. An executable is the final product of the build process, in this case our firmware. Note the startup file gets added along with the C sources.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    target_include_directories(<span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Core/Inc</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Add the include directories for the executable. Since we don&rsquo;t need the includes to propagate up as our executable is the final product of the build process, we are including as <code>PRIVATE</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    target_compile_options(<span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wall</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wextra</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wshadow</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wconversion</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">-Wdouble-promotion</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This adds <a href="https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html">additional warning compiler flags</a> to our executable target, enabling them for our sources, but not third party libraries. All of these provide much more safety if not ignored.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    target_link_libraries(<span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">PRIVATE</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">Drivers</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Here we link the libraries to the executable. Same principle applies to the reasoning behind <code>PRIVATE</code>.</p>
<h2 id="post-build-commands">Post-build commands<a hidden class="anchor" aria-hidden="true" href="#post-build-commands">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_custom_command(<span style="color:#e6db74">TARGET</span> <span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">POST_BUILD</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">COMMAND</span> <span style="color:#f92672">${</span>CMAKE_SIZE_UTIL<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This creates a custom command that prints out the firmware binary size information. Example:</p>
<pre tabindex="0"><code>    text   data    bss    dec    hex filename
    3432     20   1572   5024   13a0 most_commented_embedded_cmakelists.elf
</code></pre><p><code>text</code> is the code, <code>data</code> stores variables that have a non-zero initial value and have to be stored in flash, <code>bss</code> stores zero initial values that only take up ram. <code>dec</code> and <code>hex</code> are just the cumulative size in decimal and hexadecimal notation respectively.</p>
<p><a href="https://mcuoneclipse.com/2013/04/14/text-data-and-bss-code-and-data-size-explained/">Here</a> is a good resource for understanding these sections and to learn more about output options.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>    add_custom_command(<span style="color:#e6db74">TARGET</span> <span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">POST_BUILD</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">COMMAND</span> <span style="color:#f92672">${</span>CMAKE_OBJCOPY<span style="color:#f92672">}</span> <span style="color:#e6db74">-O</span> <span style="color:#e6db74">ihex</span> <span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">.hex</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">COMMAND</span> <span style="color:#f92672">${</span>CMAKE_OBJCOPY<span style="color:#f92672">}</span> <span style="color:#e6db74">-O</span> <span style="color:#e6db74">binary</span> <span style="color:#f92672">${</span>EXECUTABLE<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span><span style="color:#e6db74">.bin</span>
</span></span><span style="display:flex;"><span>    )<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This creates a custom command to generate binary and hex files. These can be used depending on which method of loading the firmware to the MCU is used.</p>
<h2 id="closing">Closing<a hidden class="anchor" aria-hidden="true" href="#closing">#</a></h2>
<p>Hopefully this gives you an overview of how a minimal CMakeLists file for an embedded project looks like and peaked your curiosity if you&rsquo;ve never used CMake for embedded projects.</p>
<p>It is worth keeping in mind that this article is not a complete guide to CMake and doesn&rsquo;t go into toolchain files, library CMakeLists and other things required for a complete CMake-based embedded project, however the <a href="https://github.com/DNedic/most_commented_embedded_cmakelists">project on GitHub</a> used for demonstration contains all of those and can be used as a template.</p>
<hr>
<p>© 2023 - Djordje Nedic | Find me on <a href="https://www.linkedin.com/in/djordje-nedic/">LinkedIn</a> or <a href="https://github.com/DNedic">GitHub</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="uildDrafts/tags/cmake/">CMake</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="uildDrafts/posts/p06-the-most-thoroughly-commented-linker-script/">
    <span class="title">« Prev</span>
    <br>
    <span>最透彻的链接器脚本注释</span>
  </a>
  <a class="next" href="uildDrafts/posts/p04-using-psp-msp-limit-registers-for-stack-overflow/">
    <span class="title">Next »</span>
    <br>
    <span>A Guide to Using ARM Stack Limit Registers</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="uildDrafts">福岚溪森</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
